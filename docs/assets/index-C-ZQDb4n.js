import{s as K,t as re,v,w as ie,b as ce,C as de,k,x as C,U as ge,l as A,y as le,z as me,B as m,A as L,D as X,E as ue,F as pe,G as N,H,I as V,a as he,J as fe,K as we,L as Se,M as ye,N as Ee,O as Ce,P as Ie,Q as Ue,R as Ae,q as Oe}from"./tokenProvider-DBVdkMvT.js";import{au as O,b6 as _e,b7 as I,b8 as U,at as J,b9 as Te,ba as Pe,bb as Re}from"./index-bivHVviI.js";import{m as St}from"./index-bivHVviI.js";function q(){return O.Auth.clearCredentials()}const ke=e=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=[],o=new Uint8Array(e);K().getRandomValues(o);for(const s of o)n.push(t[s%t.length]);return n.join("")};function ve(e){return(e.match(/.{2}/g)||[]).map(n=>String.fromCharCode(parseInt(n,16))).join("")}function Ne(e){return Array.from(e,t=>String.fromCodePoint(t)).join("")}const Me={convert(e,t={urlSafe:!1,skipPadding:!1}){const n=typeof e=="string"?e:Ne(e);let o=re()(n);return t.urlSafe&&(o=o.replace(/\+/g,"-").replace(/\//g,"_")),t.skipPadding&&(o=o.replace(/=/g,"")),o}};var i;(function(e){e.EmptySignInUsername="EmptySignInUsername",e.EmptySignInPassword="EmptySignInPassword",e.CustomAuthSignInPassword="CustomAuthSignInPassword",e.EmptySignUpUsername="EmptySignUpUsername",e.EmptySignUpPassword="EmptySignUpPassword",e.EmptyConfirmSignUpUsername="EmptyConfirmSignUpUsername",e.EmptyConfirmSignUpCode="EmptyConfirmSignUpCode",e.EmptyResendSignUpCodeUsername="EmptyresendSignUpCodeUsername",e.EmptyChallengeResponse="EmptyChallengeResponse",e.EmptyConfirmResetPasswordUsername="EmptyConfirmResetPasswordUsername",e.EmptyConfirmResetPasswordNewPassword="EmptyConfirmResetPasswordNewPassword",e.EmptyConfirmResetPasswordConfirmationCode="EmptyConfirmResetPasswordConfirmationCode",e.EmptyResetPasswordUsername="EmptyResetPasswordUsername",e.EmptyVerifyTOTPSetupCode="EmptyVerifyTOTPSetupCode",e.EmptyConfirmUserAttributeCode="EmptyConfirmUserAttributeCode",e.IncorrectMFAMethod="IncorrectMFAMethod",e.EmptyUpdatePassword="EmptyUpdatePassword"})(i||(i={}));i.EmptyChallengeResponse+"",i.EmptyConfirmResetPasswordUsername+"",i.EmptyConfirmSignUpCode+"",i.EmptyConfirmSignUpUsername+"",i.EmptyConfirmResetPasswordConfirmationCode+"",i.EmptyConfirmResetPasswordNewPassword+"",i.EmptyResendSignUpCodeUsername+"",i.EmptyResetPasswordUsername+"",i.EmptySignInPassword+"",i.EmptySignInUsername+"",i.EmptySignUpPassword+"",i.EmptySignUpUsername+"",i.CustomAuthSignInPassword+"",i.IncorrectMFAMethod+"",i.EmptyVerifyTOTPSetupCode+"",i.EmptyUpdatePassword+"",i.EmptyConfirmUserAttributeCode+"";var c;(function(e){e.DEFAULT_MSG="Authentication Error",e.EMPTY_EMAIL="Email cannot be empty",e.EMPTY_PHONE="Phone number cannot be empty",e.EMPTY_USERNAME="Username cannot be empty",e.INVALID_USERNAME="The username should either be a string or one of the sign in types",e.EMPTY_PASSWORD="Password cannot be empty",e.EMPTY_CODE="Confirmation code cannot be empty",e.SIGN_UP_ERROR="Error creating account",e.NO_MFA="No valid MFA method provided",e.INVALID_MFA="Invalid MFA type",e.EMPTY_CHALLENGE="Challenge response cannot be empty",e.NO_USER_SESSION="Failed to get the session because the user is empty",e.NETWORK_ERROR="Network Error",e.DEVICE_CONFIG="Device tracking has not been configured in this User Pool",e.AUTOSIGNIN_ERROR="Please use your credentials to sign in",e.OAUTH_ERROR="Couldn't finish OAuth flow, check your User Pool HostedUI settings"})(c||(c={}));var F;(function(e){e.SignInException="SignInException",e.OAuthSignInError="OAuthSignInException"})(F||(F={}));const De=async e=>{const t=e.getConfig().Auth?.Cognito;v(t);const n=await e.Auth.getTokens({forceRefresh:!1});ie(n);const{"cognito:username":o,sub:s}=n.idToken?.payload??{},a={username:o,userId:s},r=Fe(n);return r&&(a.signInDetails=r),a};function Fe(e){return e?.signInDetails}const Q=async()=>De(O),G=(e,t)=>ce({category:de.Auth,action:e,...t});async function Z(e){if(e.AccessToken){const t=k(e.AccessToken),n=(t.payload.iat||0)*1e3,o=new Date().getTime(),s=n>0?n-o:0;let a,r,d;e.RefreshToken&&(r=e.RefreshToken),e.IdToken&&(a=k(e.IdToken)),e?.NewDeviceMetadata&&(d=e.NewDeviceMetadata);const g={accessToken:t,idToken:a,refreshToken:r,clockDrift:s,deviceMetadata:d,username:e.username};e?.signInDetails&&(g.signInDetails=e.signInDetails),await C.setTokens({tokens:g})}else throw new _e({message:"Invalid tokens",name:"InvalidTokens",recoverySuggestion:"Check Cognito UserPool settings"})}const be="Unable to get user session following successful sign-in.",Le=async()=>{try{I.dispatch("auth",{event:"signedIn",data:await Q()},"Auth",U)}catch(e){throw e.name===ge?new A({name:le,message:be,recoverySuggestion:"This most likely is due to auth tokens not being persisted. If you are using cookie store, please ensure cookies can be correctly set from your server."}):e}};async function He(){let e;try{e=await Q()}catch{}if(e&&e.userId&&e.username)throw new A({name:me,message:"There is already a signed in user.",recoverySuggestion:"Call signOut before calling signIn again."})}new J("AuthError");const Ge={oauthSignInError:{message:c.OAUTH_ERROR,log:"Make sure Cognito Hosted UI has been configured correctly"},noConfig:{message:c.DEFAULT_MSG},missingAuthConfig:{message:c.DEFAULT_MSG},emptyUsername:{message:c.EMPTY_USERNAME},invalidUsername:{message:c.INVALID_USERNAME},emptyPassword:{message:c.EMPTY_PASSWORD},emptyCode:{message:c.EMPTY_CODE},signUpError:{message:c.SIGN_UP_ERROR},noMFA:{message:c.NO_MFA},invalidMFA:{message:c.INVALID_MFA},emptyChallengeResponse:{message:c.EMPTY_CHALLENGE},noUserSession:{message:c.NO_USER_SESSION},deviceConfig:{message:c.DEVICE_CONFIG},networkError:{message:c.NETWORK_ERROR},autoSignInError:{message:c.AUTOSIGNIN_ERROR},default:{message:c.DEFAULT_MSG}},w=(e,t)=>new A({message:e??"An error has occurred during the oauth process.",name:F.OAuthSignInError,recoverySuggestion:Ge.oauthSignInError.log});var b;(function(e){e.NoConfig="noConfig",e.MissingAuthConfig="missingAuthConfig",e.EmptyUsername="emptyUsername",e.InvalidUsername="invalidUsername",e.EmptyPassword="emptyPassword",e.EmptyCode="emptyCode",e.SignUpError="signUpError",e.NoMFA="noMFA",e.InvalidMFA="invalidMFA",e.EmptyChallengeResponse="emptyChallengeResponse",e.NoUserSession="noUserSession",e.Default="default",e.DeviceConfig="deviceConfig",e.NetworkError="networkError",e.AutoSignInError="autoSignInError",e.OAuthSignInError="oauthSignInError"})(b||(b={}));const We="`signInWithRedirect` has been canceled.",Ye="An error occurred while validating the state.",xe="Try to initiate an OAuth flow from Amplify",ee=async e=>{const t=await m.loadOAuthState(),n=e===t?t:void 0;if(!n)throw new A({name:b.OAuthSignInError,message:e===null?We:Ye,recoverySuggestion:e===null?void 0:xe});return n},te=async({currentUrl:e,userAgentValue:t,clientId:n,redirectUri:o,responseType:s,domain:a,preferPrivateSession:r})=>{const d=new L(e),g=d.searchParams.get("error"),p=d.searchParams.get("error_description");if(g)throw w(p??g);return s==="code"?je({currentUrl:e,userAgentValue:t,clientId:n,redirectUri:o,domain:a,preferPrivateSession:r}):Be({currentUrl:e,redirectUri:o,preferPrivateSession:r})},je=async({currentUrl:e,userAgentValue:t,clientId:n,redirectUri:o,domain:s,preferPrivateSession:a})=>{const r=new L(e),d=r.searchParams.get("code"),g=r.searchParams.get("state");if(!d||!g)throw w("User cancelled OAuth flow.");const p=await ee(g),u="https://"+s+"/oauth2/token",S=await m.loadPKCE(),y={grant_type:"authorization_code",code:d,client_id:n,redirect_uri:o,...S?{code_verifier:S}:{}},h=Object.entries(y).map(([P,l])=>`${encodeURIComponent(P)}=${encodeURIComponent(l)}`).join("&"),{access_token:f,refresh_token:E,id_token:M,error:_,error_message:T,token_type:x,expires_in:j}=await(await fetch(u,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",[Te]:t},body:h})).json();if(_)throw w(T??_);const D=(f&&k(f).payload.username)??"username";return await Z({username:D,AccessToken:f,IdToken:M,RefreshToken:E}),ne({redirectUri:o,state:p,preferPrivateSession:a})},Be=async({currentUrl:e,redirectUri:t,preferPrivateSession:n})=>{const o=new L(e),{id_token:s,access_token:a,state:r,token_type:d,expires_in:g,error_description:p,error:u}=(o.hash??"#").substring(1).split("&").map(h=>h.split("=")).reduce((h,[f,E])=>({...h,[f]:E}),{id_token:void 0,access_token:void 0,state:void 0,token_type:void 0,expires_in:void 0,error_description:void 0,error:void 0});if(u)throw w(p??u);if(!a)throw w("No access token returned from OAuth flow.");const S=await ee(r),y=(a&&k(a).payload.username)??"username";return await Z({username:y,AccessToken:a,IdToken:s}),ne({redirectUri:t,state:S,preferPrivateSession:n})},ne=async({redirectUri:e,state:t,preferPrivateSession:n})=>{await C.setOAuthMetadata({oauthSignIn:!0}),await m.clearOAuthData(),await m.storeOAuthSignIn(!0,n),X(),Ke(e),$e(t)&&I.dispatch("auth",{event:"customOAuthState",data:ve(ze(t))},"Auth",U),I.dispatch("auth",{event:"signInWithRedirect"},"Auth",U),await Le()},$e=e=>/-/.test(e),ze=e=>e.split("-").splice(1).join("-"),Ke=e=>{typeof window<"u"&&typeof window.history<"u"&&window.history.replaceState(window.history.state,"",e)};function W(e,t){{const n=e?.find(Xe)??e?.find(Ve),o=e?.find(qe)??e?.find(Je);if(n)return n;throw o?ue:pe}}const Xe=e=>e.startsWith(String(window.location.origin+(window.location.pathname||"/"))),Ve=e=>e.includes(String(window.location.hostname)),Je=e=>e.startsWith("http://"),qe=e=>e.startsWith("https://"),Y=async e=>{X(),await m.clearOAuthInflightData(),I.dispatch("auth",{event:"signInWithRedirect_failure",data:{error:e}},"Auth",U)},Qe=async e=>{try{v(e),N(e),m.setAuthConfig(e)}catch{return}if(await m.loadOAuthInFlight())try{const t=window.location.href,{loginWith:n,userPoolClientId:o}=e,{domain:s,redirectSignIn:a,responseType:r}=n.oauth,d=W(a);await te({currentUrl:t,clientId:o,domain:s,redirectUri:d,responseType:r,userAgentValue:G(H.SignInWithRedirect)})}catch(t){await Y(t)}};V()&&O[Pe](Qe);const oe=async e=>{window?.location&&(window.location.href=e.replace("http://","https://"))},z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Ze=e=>{const t=new Uint8Array(e);K().getRandomValues(t);let n="",o;for(const s of t)n+=z.charAt(s%z.length);return{value:n,method:"S256",toCodeChallenge(){return o||(o=et(n),o)}}};function et(e){const t=new Re;return t.update(e),tt(Me.convert(t.digestSync(),{urlSafe:!0}))}function tt(e){return e.replace(/=/g,"")}const nt=()=>ke(32),ot=e=>{async function t(n){if(n.persisted&&await e.loadOAuthInFlight()){const s=w("User cancelled OAuth flow.");await Y(s)}window.removeEventListener("pageshow",t)}window.addEventListener("pageshow",t)};async function pt(e){const t=O.getConfig().Auth?.Cognito;return v(t),N(t),m.setAuthConfig(t),await He(),st({oauthConfig:t.loginWith.oauth,clientId:t.userPoolClientId,provider:"COGNITO",idpIdentifier:void 0,customState:e?.customState,preferPrivateSession:e?.options?.preferPrivateSession,options:{loginHint:e?.options?.loginHint,lang:e?.options?.lang,nonce:e?.options?.nonce,prompt:e?.options?.prompt},authSessionOpener:e?.options?.authSessionOpener})}const st=async({oauthConfig:e,provider:t,idpIdentifier:n,clientId:o,customState:s,preferPrivateSession:a,options:r,authSessionOpener:d})=>{const{domain:g,redirectSignIn:p,responseType:u,scopes:S}=e,{loginHint:y,lang:h,nonce:f,prompt:E}=r??{},M=nt(),_=oe,T=M,{value:x,method:j,toCodeChallenge:D}=Ze(128),P=W(e.redirectSignIn);V()&&m.storeOAuthInFlight(!0),m.storeOAuthState(T),m.storePKCE(x);const l=new URLSearchParams([["redirect_uri",P],["response_type",u],["client_id",o]]);l.append("identity_provider",t),l.append("scope",S.join(" ")),y&&l.append("login_hint",y),h&&l.append("lang",h),f&&l.append("nonce",f),E&&l.append("prompt",E.toLowerCase()),l.append("state",T),u==="code"&&(l.append("code_challenge",D()),l.append("code_challenge_method",j));const se=`https://${g}/oauth2/authorize?${l.toString()}`;ot(m);const{type:R,error:ae,url:B}=await _(se,p,a)??{};try{if(R==="error")throw w(String(ae));if(R==="canceled")throw w(String(R));R==="success"&&B&&await te({currentUrl:B,clientId:o,domain:g,redirectUri:P,responseType:u,userAgentValue:G(H.SignInWithRedirect),preferPrivateSession:a})}catch($){throw await Y($),$}},at=async e=>{await e.clearOAuthData(),C.clearTokens(),await q(),I.dispatch("auth",{event:"signedOut"},"Auth",U)},rt=async(e,t=!1,n)=>{N(e);const{loginWith:o,userPoolClientId:s}=e,{domain:a,redirectSignOut:r}=o.oauth,d=W(r),g=`https://${a}/logout?${Object.entries({client_id:s,logout_uri:encodeURIComponent(d)}).map(([p,u])=>`${p}=${u}`).join("&")}`;return oe(g)},it=async(e,t,n,o)=>{const{isOAuthSignIn:s}=await t.loadOAuthSignIn(),a=await n.getOAuthMetadata();if(await at(t),s||a?.oauthSignIn)return rt(e,!1)},ct=e=>he(ye,Se("RevokeToken"),we(),{...fe,...e}),dt=new J("Auth");async function ht(e){const t=O.getConfig().Auth?.Cognito;v(t),await gt(t);let n;try{N(t),n=!0}catch{n=!1}if(n){const o=new Ee(Oe);o.setAuthConfig(t);const{type:s}=await it(t,o,C)??{};if(s==="error")throw new A({name:Ce,message:"An error occurred when attempting to log out from OAuth provider."})}else C.clearTokens(),await q(),I.dispatch("auth",{event:"signedOut"},"Auth",U)}async function gt(e){try{const{userPoolEndpoint:t,userPoolId:n,userPoolClientId:o}=e,s=await C.getTokenStore().loadTokens();Ie(s),lt(s.accessToken)&&await ct({endpointResolver:Ue({endpointOverride:t})})({region:Ae(n),userAgentValue:G(H.SignOut)},{ClientId:o,Token:s.refreshToken})}catch{dt.debug("Client signOut error caught but will proceed with token removal")}}const lt=e=>!!e?.payload?.origin_jti;export{A as AuthError,k as decodeJWT,St as fetchAuthSession,Q as getCurrentUser,pt as signInWithRedirect,ht as signOut};
