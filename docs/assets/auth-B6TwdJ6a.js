import{at as _,au as c,av as z}from"./index-BeZvCyrH.js";import{j as U,g as b,p as w,c as $,u as B,a as T,b as k,d as x,e as P,A as R,f as H,h as g,i as N,k as M,l,m as p,n as C,o as q,q as E,r as I}from"./tokenProvider-vMr_vT0O.js";const K="cognito-identity",D={service:K,retryDecider:b(w),computeDelay:U,cache:"no-store"},J=()=>t=>async function(n){return n.headers["cache-control"]="no-store",t(n)},F=$(B,[J]),G=t=>(e,n)=>{const o=W(t),i=JSON.stringify(e);return Z(n,o,i)},W=t=>({"content-type":"application/x-amz-json-1.1","x-amz-target":`AWSCognitoIdentityService.${t}`}),Z=({url:t},e,n)=>({headers:e,url:t,body:n,method:"POST"}),S=t=>T(F,G("GetCredentialsForIdentity"),Y,{...D,...t,userAgentValue:k()}),Y=async t=>{if(t.statusCode>=300)throw await w(t);const e=await x(t);return{IdentityId:e.IdentityId,Credentials:Q(e.Credentials),$metadata:P(t)}},Q=({Expiration:t,...e}={})=>({...e,Expiration:t&&new Date(t*1e3)}),X=t=>T(F,G("GetId"),ee,{...D,...t,userAgentValue:k()}),ee=async t=>{if(t.statusCode>=300)throw await w(t);return{IdentityId:(await x(t)).IdentityId,$metadata:P(t)}},te=({region:t})=>({url:new R(`https://${K}.${t}.${H(t)}`)});function y(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)t[o]=n[o]}return t}var ne={read:function(t){return t[0]==='"'&&(t=t.slice(1,-1)),t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(t){return encodeURIComponent(t).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function m(t,e){function n(i,r,s){if(!(typeof document>"u")){s=y({},e,s),typeof s.expires=="number"&&(s.expires=new Date(Date.now()+s.expires*864e5)),s.expires&&(s.expires=s.expires.toUTCString()),i=encodeURIComponent(i).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var d="";for(var a in s)s[a]&&(d+="; "+a,s[a]!==!0&&(d+="="+s[a].split(";")[0]));return document.cookie=i+"="+t.write(r,i)+d}}function o(i){if(!(typeof document>"u"||arguments.length&&!i)){for(var r=document.cookie?document.cookie.split("; "):[],s={},d=0;d<r.length;d++){var a=r[d].split("="),O=a.slice(1).join("=");try{var f=decodeURIComponent(a[0]);if(s[f]=t.read(O,f),i===f)break}catch{}}return i?s[i]:s}}return Object.create({set:n,get:o,remove:function(i,r){n(i,"",y({},r,{expires:-1}))},withAttributes:function(i){return m(this.converter,y({},this.attributes,i))},withConverter:function(i){return m(y({},this.converter,i),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(t)}})}var u=m(ne,{path:"/"});class ie{constructor(e={}){const{path:n,domain:o,expires:i,sameSite:r,secure:s}=e;if(this.domain=o,this.path=n||"/",this.expires=Object.prototype.hasOwnProperty.call(e,"expires")?i:365,this.secure=Object.prototype.hasOwnProperty.call(e,"secure")?s:!0,Object.prototype.hasOwnProperty.call(e,"sameSite")){if(!r||!["strict","lax","none"].includes(r))throw new Error('The sameSite value of cookieStorage must be "lax", "strict" or "none".');if(r==="none"&&!this.secure)throw new Error("sameSite = None requires the Secure attribute in latest browser versions.");this.sameSite=r}}async setItem(e,n){u.set(e,n,this.getData())}async getItem(e){return u.get(e)??null}async removeItem(e){u.remove(e,this.getData())}async clear(){const e=u.get(),n=Object.keys(e).map(o=>this.removeItem(o));await Promise.all(n)}getData(){return{path:this.path,expires:this.expires,domain:this.domain,secure:this.secure,...this.sameSite&&{sameSite:this.sameSite}}}}const re={identityId:"identityId"},se=new _("DefaultIdentityIdStore");class j{setAuthConfig(e){g(e.Cognito),this.authConfig=e,this._authKeys=oe("Cognito",e.Cognito.identityPoolId)}constructor(e){this._authKeys={},this._hasGuestIdentityId=!1,this.keyValueStorage=e}async loadIdentityId(){g(this.authConfig?.Cognito);try{if(this._primaryIdentityId)return{id:this._primaryIdentityId,type:"primary"};{const e=await this.keyValueStorage.getItem(this._authKeys.identityId);return e?(this._hasGuestIdentityId=!0,{id:e,type:"guest"}):null}}catch(e){return se.log("Error getting stored IdentityId.",e),null}}async storeIdentityId(e){g(this.authConfig?.Cognito),e.type==="guest"?(this.keyValueStorage.setItem(this._authKeys.identityId,e.id),this._primaryIdentityId=void 0,this._hasGuestIdentityId=!0):(this._primaryIdentityId=e.id,this._hasGuestIdentityId&&(this.keyValueStorage.removeItem(this._authKeys.identityId),this._hasGuestIdentityId=!1))}async clearIdentityId(){this._primaryIdentityId=void 0,await this.keyValueStorage.removeItem(this._authKeys.identityId)}}const oe=(t,e)=>N(re)(`com.amplify.${t}`,e),A=({endpointOverride:t})=>e=>t?{url:new R(t)}:te(e);function L(t){const e=M(t).payload.iss,n={};if(!e)throw new l({name:"InvalidIdTokenException",message:"Invalid Idtoken."});const o=e.replace(/(^\w+:|^)\/\//,"");return n[o]=t,n}async function de({tokens:t,authConfig:e,identityIdStore:n}){n.setAuthConfig({Cognito:e});const o=await n.loadIdentityId();if(o)return o.id;const i=t?.idToken?L(t.idToken.toString()):{},r=await ae(i,e);return n.storeIdentityId({id:r,type:t?"primary":"guest"}),r}async function ae(t,e){const n=e?.identityPoolId,o=p(n),i=X({endpointResolver:A({endpointOverride:e.identityPoolEndpoint})});let r;try{r=(await i({region:o},{IdentityPoolId:n,Logins:t})).IdentityId}catch(s){throw C(s),new l(s)}if(!r)throw new l({name:"GetIdResponseException",message:"Received undefined response from getId operation",recoverySuggestion:"Make sure to pass a valid identityPoolId in the configuration."});return r}const h=new _("CognitoCredentialsProvider"),v=3e3*1e3;class V{constructor(e){this._nextCredentialsRefresh=0,this._identityIdStore=e}async clearCredentialsAndIdentityId(){h.debug("Clearing out credentials and identityId"),this._credentialsAndIdentityId=void 0,await this._identityIdStore.clearIdentityId()}async clearCredentials(){h.debug("Clearing out in-memory credentials"),this._credentialsAndIdentityId=void 0}async getCredentialsAndIdentityId(e){const n=e.authenticated,{tokens:o}=e,{authConfig:i}=e;try{g(i?.Cognito)}catch{return}if(!n&&!i.Cognito.allowGuestAccess)return;const{forceRefresh:r}=e,s=this.hasTokenChanged(o),d=await de({tokens:o,authConfig:i.Cognito,identityIdStore:this._identityIdStore});return(r||s)&&this.clearCredentials(),n?(q(o),this.credsForOIDCTokens(i.Cognito,o,d)):this.getGuestCredentials(d,i.Cognito)}async getGuestCredentials(e,n){if(this._credentialsAndIdentityId&&!this.isPastTTL()&&this._credentialsAndIdentityId.isAuthenticatedCreds===!1)return h.info("returning stored credentials as they neither past TTL nor expired."),this._credentialsAndIdentityId;this.clearCredentials();const o=p(n.identityPoolId),i=S({endpointResolver:A({endpointOverride:n.identityPoolEndpoint})});let r;try{r=await i({region:o},{IdentityId:e})}catch(s){throw C(s),new l(s)}if(r?.Credentials?.AccessKeyId&&r?.Credentials?.SecretKey){this._nextCredentialsRefresh=new Date().getTime()+v;const s={credentials:{accessKeyId:r.Credentials.AccessKeyId,secretAccessKey:r.Credentials.SecretKey,sessionToken:r.Credentials.SessionToken,expiration:r.Credentials.Expiration},identityId:e};return r.IdentityId&&(s.identityId=r.IdentityId,this._identityIdStore.storeIdentityId({id:r.IdentityId,type:"guest"})),this._credentialsAndIdentityId={...s,isAuthenticatedCreds:!1},s}else throw new l({name:"CredentialsNotFoundException",message:"Cognito did not respond with either Credentials, AccessKeyId or SecretKey."})}async credsForOIDCTokens(e,n,o){if(this._credentialsAndIdentityId&&!this.isPastTTL()&&this._credentialsAndIdentityId.isAuthenticatedCreds===!0)return h.debug("returning stored credentials as they neither past TTL nor expired."),this._credentialsAndIdentityId;this.clearCredentials();const i=n.idToken?L(n.idToken.toString()):{},r=p(e.identityPoolId),s=S({endpointResolver:A({endpointOverride:e.identityPoolEndpoint})});let d;try{d=await s({region:r},{IdentityId:o,Logins:i})}catch(a){throw C(a),new l(a)}if(d?.Credentials?.AccessKeyId&&d?.Credentials?.SecretKey){this._nextCredentialsRefresh=new Date().getTime()+v;const a={credentials:{accessKeyId:d.Credentials.AccessKeyId,secretAccessKey:d.Credentials.SecretKey,sessionToken:d.Credentials.SessionToken,expiration:d.Credentials.Expiration},identityId:o};return d.IdentityId&&(a.identityId=d.IdentityId,this._identityIdStore.storeIdentityId({id:d.IdentityId,type:"primary"})),this._credentialsAndIdentityId={...a,isAuthenticatedCreds:!0,associatedIdToken:n.idToken?.toString()},a}else throw new l({name:"CredentialsException",message:"Cognito did not respond with either Credentials, AccessKeyId or SecretKey."})}isPastTTL(){return this._nextCredentialsRefresh===void 0?!0:this._nextCredentialsRefresh<=Date.now()}hasTokenChanged(e){return!!e&&!!this._credentialsAndIdentityId?.associatedIdToken&&e.idToken?.toString()!==this._credentialsAndIdentityId.associatedIdToken}}const ce=new V(new j(E)),le={configure(t,e){const n=z(t),o=new ie({sameSite:"lax"}),i=e?.ssr?o:E,r=e?.ssr?new V(new j(o)):ce;if(!n.Auth){c.configure(n,e);return}if(e?.Auth){c.configure(n,e);return}if(!c.libraryOptions.Auth){I.setAuthConfig(n.Auth),I.setKeyValueStorage(i),c.configure(n,{...e,Auth:{tokenProvider:I,credentialsProvider:r}});return}if(e){const s=c.libraryOptions.Auth;e.ssr!==void 0&&(I.setKeyValueStorage(i),s.credentialsProvider=r),c.configure(n,{Auth:s,...e});return}c.configure(n)},getConfig(){return c.getConfig()}},Ie={Auth:{Cognito:{userPoolId:"ap-southeast-2_hyHAlZnZv",userPoolClientId:"djs4o25tq4q0qmramo44tji2t",loginWith:{oauth:{domain:"ap-southeast-2hyhalznzv.auth.ap-southeast-2.amazoncognito.com",scopes:["openid","email","phone"],redirectSignIn:["http://localhost:9000/"],redirectSignOut:["http://localhost:9000/"],responseType:"code"}}}}},ge=()=>{le.configure(Ie)};export{ge as default};
