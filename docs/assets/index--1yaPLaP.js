import{s as K,t as re,v,w as ie,b as ce,C as de,k,x as C,U as ge,l as A,y as le,z as me,B as m,A as L,D as X,E as pe,F as ue,G as N,H,I as V,a as he,J as fe,K as we,L as Se,M as ye,N as Ee,O as Ce,P as Ie,Q as Ue,R as Ae,q as Oe}from"./tokenProvider-CsQi9QZ3.js";import{aA as O,bb as _e,bc as I,bd as U,az as J,be as Te,bf as Pe,bg as Re}from"./index-D44IgZtN.js";import{p as yn}from"./index-D44IgZtN.js";function q(){return O.Auth.clearCredentials()}const ke=e=>{const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=[],o=new Uint8Array(e);K().getRandomValues(o);for(const s of o)t.push(n[s%n.length]);return t.join("")};function ve(e){return(e.match(/.{2}/g)||[]).map(t=>String.fromCharCode(parseInt(t,16))).join("")}function Ne(e){return Array.from(e,n=>String.fromCodePoint(n)).join("")}const Me={convert(e,n={urlSafe:!1,skipPadding:!1}){const t=typeof e=="string"?e:Ne(e);let o=re()(t);return n.urlSafe&&(o=o.replace(/\+/g,"-").replace(/\//g,"_")),n.skipPadding&&(o=o.replace(/=/g,"")),o}};var i;(function(e){e.EmptySignInUsername="EmptySignInUsername",e.EmptySignInPassword="EmptySignInPassword",e.CustomAuthSignInPassword="CustomAuthSignInPassword",e.EmptySignUpUsername="EmptySignUpUsername",e.EmptySignUpPassword="EmptySignUpPassword",e.EmptyConfirmSignUpUsername="EmptyConfirmSignUpUsername",e.EmptyConfirmSignUpCode="EmptyConfirmSignUpCode",e.EmptyResendSignUpCodeUsername="EmptyresendSignUpCodeUsername",e.EmptyChallengeResponse="EmptyChallengeResponse",e.EmptyConfirmResetPasswordUsername="EmptyConfirmResetPasswordUsername",e.EmptyConfirmResetPasswordNewPassword="EmptyConfirmResetPasswordNewPassword",e.EmptyConfirmResetPasswordConfirmationCode="EmptyConfirmResetPasswordConfirmationCode",e.EmptyResetPasswordUsername="EmptyResetPasswordUsername",e.EmptyVerifyTOTPSetupCode="EmptyVerifyTOTPSetupCode",e.EmptyConfirmUserAttributeCode="EmptyConfirmUserAttributeCode",e.IncorrectMFAMethod="IncorrectMFAMethod",e.EmptyUpdatePassword="EmptyUpdatePassword"})(i||(i={}));i.EmptyChallengeResponse+"",i.EmptyConfirmResetPasswordUsername+"",i.EmptyConfirmSignUpCode+"",i.EmptyConfirmSignUpUsername+"",i.EmptyConfirmResetPasswordConfirmationCode+"",i.EmptyConfirmResetPasswordNewPassword+"",i.EmptyResendSignUpCodeUsername+"",i.EmptyResetPasswordUsername+"",i.EmptySignInPassword+"",i.EmptySignInUsername+"",i.EmptySignUpPassword+"",i.EmptySignUpUsername+"",i.CustomAuthSignInPassword+"",i.IncorrectMFAMethod+"",i.EmptyVerifyTOTPSetupCode+"",i.EmptyUpdatePassword+"",i.EmptyConfirmUserAttributeCode+"";var c;(function(e){e.DEFAULT_MSG="Authentication Error",e.EMPTY_EMAIL="Email cannot be empty",e.EMPTY_PHONE="Phone number cannot be empty",e.EMPTY_USERNAME="Username cannot be empty",e.INVALID_USERNAME="The username should either be a string or one of the sign in types",e.EMPTY_PASSWORD="Password cannot be empty",e.EMPTY_CODE="Confirmation code cannot be empty",e.SIGN_UP_ERROR="Error creating account",e.NO_MFA="No valid MFA method provided",e.INVALID_MFA="Invalid MFA type",e.EMPTY_CHALLENGE="Challenge response cannot be empty",e.NO_USER_SESSION="Failed to get the session because the user is empty",e.NETWORK_ERROR="Network Error",e.DEVICE_CONFIG="Device tracking has not been configured in this User Pool",e.AUTOSIGNIN_ERROR="Please use your credentials to sign in",e.OAUTH_ERROR="Couldn't finish OAuth flow, check your User Pool HostedUI settings"})(c||(c={}));var F;(function(e){e.SignInException="SignInException",e.OAuthSignInError="OAuthSignInException"})(F||(F={}));const De=async e=>{const n=e.getConfig().Auth?.Cognito;v(n);const t=await e.Auth.getTokens({forceRefresh:!1});ie(t);const{"cognito:username":o,sub:s}=t.idToken?.payload??{},a={username:o,userId:s},r=Fe(t);return r&&(a.signInDetails=r),a};function Fe(e){return e?.signInDetails}const Q=async()=>De(O),G=(e,n)=>ce({category:de.Auth,action:e,...n});async function Z(e){if(e.AccessToken){const n=k(e.AccessToken),t=(n.payload.iat||0)*1e3,o=new Date().getTime(),s=t>0?t-o:0;let a,r,d;e.RefreshToken&&(r=e.RefreshToken),e.IdToken&&(a=k(e.IdToken)),e?.NewDeviceMetadata&&(d=e.NewDeviceMetadata);const g={accessToken:n,idToken:a,refreshToken:r,clockDrift:s,deviceMetadata:d,username:e.username};e?.signInDetails&&(g.signInDetails=e.signInDetails),await C.setTokens({tokens:g})}else throw new _e({message:"Invalid tokens",name:"InvalidTokens",recoverySuggestion:"Check Cognito UserPool settings"})}const be="Unable to get user session following successful sign-in.",Le=async()=>{try{I.dispatch("auth",{event:"signedIn",data:await Q()},"Auth",U)}catch(e){throw e.name===ge?new A({name:le,message:be,recoverySuggestion:"This most likely is due to auth tokens not being persisted. If you are using cookie store, please ensure cookies can be correctly set from your server."}):e}};async function He(){let e;try{e=await Q()}catch{}if(e&&e.userId&&e.username)throw new A({name:me,message:"There is already a signed in user.",recoverySuggestion:"Call signOut before calling signIn again."})}new J("AuthError");const Ge={oauthSignInError:{message:c.OAUTH_ERROR,log:"Make sure Cognito Hosted UI has been configured correctly"},noConfig:{message:c.DEFAULT_MSG},missingAuthConfig:{message:c.DEFAULT_MSG},emptyUsername:{message:c.EMPTY_USERNAME},invalidUsername:{message:c.INVALID_USERNAME},emptyPassword:{message:c.EMPTY_PASSWORD},emptyCode:{message:c.EMPTY_CODE},signUpError:{message:c.SIGN_UP_ERROR},noMFA:{message:c.NO_MFA},invalidMFA:{message:c.INVALID_MFA},emptyChallengeResponse:{message:c.EMPTY_CHALLENGE},noUserSession:{message:c.NO_USER_SESSION},deviceConfig:{message:c.DEVICE_CONFIG},networkError:{message:c.NETWORK_ERROR},autoSignInError:{message:c.AUTOSIGNIN_ERROR},default:{message:c.DEFAULT_MSG}},w=(e,n)=>new A({message:e??"An error has occurred during the oauth process.",name:F.OAuthSignInError,recoverySuggestion:Ge.oauthSignInError.log});var b;(function(e){e.NoConfig="noConfig",e.MissingAuthConfig="missingAuthConfig",e.EmptyUsername="emptyUsername",e.InvalidUsername="invalidUsername",e.EmptyPassword="emptyPassword",e.EmptyCode="emptyCode",e.SignUpError="signUpError",e.NoMFA="noMFA",e.InvalidMFA="invalidMFA",e.EmptyChallengeResponse="emptyChallengeResponse",e.NoUserSession="noUserSession",e.Default="default",e.DeviceConfig="deviceConfig",e.NetworkError="networkError",e.AutoSignInError="autoSignInError",e.OAuthSignInError="oauthSignInError"})(b||(b={}));const We="`signInWithRedirect` has been canceled.",Ye="An error occurred while validating the state.",xe="Try to initiate an OAuth flow from Amplify",ee=async e=>{const n=await m.loadOAuthState(),t=e===n?n:void 0;if(!t)throw new A({name:b.OAuthSignInError,message:e===null?We:Ye,recoverySuggestion:e===null?void 0:xe});return t},ne=async({currentUrl:e,userAgentValue:n,clientId:t,redirectUri:o,responseType:s,domain:a,preferPrivateSession:r})=>{const d=new L(e),g=d.searchParams.get("error"),u=d.searchParams.get("error_description");if(g)throw w(u??g);return s==="code"?je({currentUrl:e,userAgentValue:n,clientId:t,redirectUri:o,domain:a,preferPrivateSession:r}):Be({currentUrl:e,redirectUri:o,preferPrivateSession:r})},je=async({currentUrl:e,userAgentValue:n,clientId:t,redirectUri:o,domain:s,preferPrivateSession:a})=>{const r=new L(e),d=r.searchParams.get("code"),g=r.searchParams.get("state");if(!d||!g)throw w("User cancelled OAuth flow.");const u=await ee(g),p="https://"+s+"/oauth2/token",S=await m.loadPKCE(),y={grant_type:"authorization_code",code:d,client_id:t,redirect_uri:o,...S?{code_verifier:S}:{}},h=Object.entries(y).map(([P,l])=>`${encodeURIComponent(P)}=${encodeURIComponent(l)}`).join("&"),{access_token:f,refresh_token:E,id_token:M,error:_,error_message:T,token_type:x,expires_in:j}=await(await fetch(p,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",[Te]:n},body:h})).json();if(_)throw w(T??_);const D=(f&&k(f).payload.username)??"username";return await Z({username:D,AccessToken:f,IdToken:M,RefreshToken:E}),te({redirectUri:o,state:u,preferPrivateSession:a})},Be=async({currentUrl:e,redirectUri:n,preferPrivateSession:t})=>{const o=new L(e),{id_token:s,access_token:a,state:r,token_type:d,expires_in:g,error_description:u,error:p}=(o.hash??"#").substring(1).split("&").map(h=>h.split("=")).reduce((h,[f,E])=>({...h,[f]:E}),{id_token:void 0,access_token:void 0,state:void 0,token_type:void 0,expires_in:void 0,error_description:void 0,error:void 0});if(p)throw w(u??p);if(!a)throw w("No access token returned from OAuth flow.");const S=await ee(r),y=(a&&k(a).payload.username)??"username";return await Z({username:y,AccessToken:a,IdToken:s}),te({redirectUri:n,state:S,preferPrivateSession:t})},te=async({redirectUri:e,state:n,preferPrivateSession:t})=>{await C.setOAuthMetadata({oauthSignIn:!0}),await m.clearOAuthData(),await m.storeOAuthSignIn(!0,t),X(),Ke(e),$e(n)&&I.dispatch("auth",{event:"customOAuthState",data:ve(ze(n))},"Auth",U),I.dispatch("auth",{event:"signInWithRedirect"},"Auth",U),await Le()},$e=e=>/-/.test(e),ze=e=>e.split("-").splice(1).join("-"),Ke=e=>{typeof window<"u"&&typeof window.history<"u"&&window.history.replaceState(window.history.state,"",e)};function W(e,n){{const t=e?.find(Xe)??e?.find(Ve),o=e?.find(qe)??e?.find(Je);if(t)return t;throw o?pe:ue}}const Xe=e=>e.startsWith(String(window.location.origin+(window.location.pathname||"/"))),Ve=e=>e.includes(String(window.location.hostname)),Je=e=>e.startsWith("http://"),qe=e=>e.startsWith("https://"),Y=async e=>{X(),await m.clearOAuthInflightData(),I.dispatch("auth",{event:"signInWithRedirect_failure",data:{error:e}},"Auth",U)},Qe=async e=>{try{v(e),N(e),m.setAuthConfig(e)}catch{return}if(await m.loadOAuthInFlight())try{const n=window.location.href,{loginWith:t,userPoolClientId:o}=e,{domain:s,redirectSignIn:a,responseType:r}=t.oauth,d=W(a);await ne({currentUrl:n,clientId:o,domain:s,redirectUri:d,responseType:r,userAgentValue:G(H.SignInWithRedirect)})}catch(n){await Y(n)}};V()&&O[Pe](Qe);const oe=async e=>{window?.location&&(window.location.href=e.replace("http://","https://"))},z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Ze=e=>{const n=new Uint8Array(e);K().getRandomValues(n);let t="",o;for(const s of n)t+=z.charAt(s%z.length);return{value:t,method:"S256",toCodeChallenge(){return o||(o=en(t),o)}}};function en(e){const n=new Re;return n.update(e),nn(Me.convert(n.digestSync(),{urlSafe:!0}))}function nn(e){return e.replace(/=/g,"")}const tn=()=>ke(32),on=e=>{async function n(t){if(t.persisted&&await e.loadOAuthInFlight()){const s=w("User cancelled OAuth flow.");await Y(s)}window.removeEventListener("pageshow",n)}window.addEventListener("pageshow",n)};async function hn(e){const n=O.getConfig().Auth?.Cognito;return v(n),N(n),m.setAuthConfig(n),await He(),sn({oauthConfig:n.loginWith.oauth,clientId:n.userPoolClientId,provider:"COGNITO",idpIdentifier:void 0,customState:e?.customState,preferPrivateSession:e?.options?.preferPrivateSession,options:{loginHint:e?.options?.loginHint,lang:e?.options?.lang,nonce:e?.options?.nonce,prompt:e?.options?.prompt},authSessionOpener:e?.options?.authSessionOpener})}const sn=async({oauthConfig:e,provider:n,idpIdentifier:t,clientId:o,customState:s,preferPrivateSession:a,options:r,authSessionOpener:d})=>{const{domain:g,redirectSignIn:u,responseType:p,scopes:S}=e,{loginHint:y,lang:h,nonce:f,prompt:E}=r??{},M=tn(),_=oe,T=M,{value:x,method:j,toCodeChallenge:D}=Ze(128),P=W(e.redirectSignIn);V()&&m.storeOAuthInFlight(!0),m.storeOAuthState(T),m.storePKCE(x);const l=new URLSearchParams([["redirect_uri",P],["response_type",p],["client_id",o]]);l.append("identity_provider",n),l.append("scope",S.join(" ")),y&&l.append("login_hint",y),h&&l.append("lang",h),f&&l.append("nonce",f),E&&l.append("prompt",E.toLowerCase()),l.append("state",T),p==="code"&&(l.append("code_challenge",D()),l.append("code_challenge_method",j));const se=`https://${g}/oauth2/authorize?${l.toString()}`;on(m);const{type:R,error:ae,url:B}=await _(se,u,a)??{};try{if(R==="error")throw w(String(ae));if(R==="canceled")throw w(String(R));R==="success"&&B&&await ne({currentUrl:B,clientId:o,domain:g,redirectUri:P,responseType:p,userAgentValue:G(H.SignInWithRedirect),preferPrivateSession:a})}catch($){throw await Y($),$}},an=async e=>{await e.clearOAuthData(),C.clearTokens(),await q(),I.dispatch("auth",{event:"signedOut"},"Auth",U)},rn=async(e,n=!1,t)=>{N(e);const{loginWith:o,userPoolClientId:s}=e,{domain:a,redirectSignOut:r}=o.oauth,d=W(r),g=`https://${a}/logout?${Object.entries({client_id:s,logout_uri:encodeURIComponent(d)}).map(([u,p])=>`${u}=${p}`).join("&")}`;return oe(g)},cn=async(e,n,t,o)=>{const{isOAuthSignIn:s}=await n.loadOAuthSignIn(),a=await t.getOAuthMetadata();if(await an(n),s||a?.oauthSignIn)return rn(e,!1)},dn=e=>he(ye,Se("RevokeToken"),we(),{...fe,...e}),gn=new J("Auth");async function fn(e){const n=O.getConfig().Auth?.Cognito;v(n),await ln(n);let t;try{N(n),t=!0}catch{t=!1}if(t){const o=new Ee(Oe);o.setAuthConfig(n);const{type:s}=await cn(n,o,C)??{};if(s==="error")throw new A({name:Ce,message:"An error occurred when attempting to log out from OAuth provider."})}else C.clearTokens(),await q(),I.dispatch("auth",{event:"signedOut"},"Auth",U)}async function ln(e){try{const{userPoolEndpoint:n,userPoolId:t,userPoolClientId:o}=e,s=await C.getTokenStore().loadTokens();Ie(s),mn(s.accessToken)&&await dn({endpointResolver:Ue({endpointOverride:n})})({region:Ae(t),userAgentValue:G(H.SignOut)},{ClientId:o,Token:s.refreshToken})}catch{gn.debug("Client signOut error caught but will proceed with token removal")}}const mn=e=>!!e?.payload?.origin_jti;export{A as AuthError,k as decodeJWT,yn as fetchAuthSession,Q as getCurrentUser,hn as signInWithRedirect,fn as signOut};
